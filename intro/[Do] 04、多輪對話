## ğŸ”„ **æ”¯æ´å¤šè¼ªå°è©±çš„å®Œæ•´æ–¹æ¡ˆ**

### **ä¿®æ”¹å¾Œçš„ main.pyï¼ˆæ”¯æ´å¤šè¼ªå°è©±ï¼‰**

```python
# ================================
# å®Œæ•´ç‰ˆï¼šæ”¯æ´å¤šè¼ªå°è©±çš„ Grok API
# ================================

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import Optional, Dict, Any
import requests
import json
import uuid
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(
    title="Grok Mirror API - å¤šè¼ªå°è©±ç‰ˆ",
    version="4.0.0"
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

GROK_BASE_URL = "https://grok.ylsagi.com"

HEADERS = {
    "Content-Type": "application/json",
    "Cookie": 'share_token=aaf6c70a7ba8832ae9b09ac055cd1081947d2d897b3ca2b65d826ceeecbcf653; imgID=67e253bdd0b63c582005f9a7; i18nextLng=en; mp_ea93da913ddb66b6372b89d97b1029ac_mixpanel=%7B%22distinct_id%22%3A%2200a70e22-fed7-4713-b4c5-9b16ba9c856f%22%2C%22%24device_id%22%3A%229c284b9a-2aa5-4b8e-886e-78017fc21d9e%22%2C%22%24initial_referrer%22%3A%22https%3A%2F%2Fylsagi.com%2F%22%2C%22%24initial_referring_domain%22%3A%22ylsagi.com%22%2C%22__mps%22%3A%7B%7D%2C%22__mpso%22%3A%7B%7D%2C%22__mpus%22%3A%7B%7D%2C%22__mpa%22%3A%7B%7D%2C%22__mpu%22%3A%7B%7D%2C%22__mpr%22%3A%5B%5D%2C%22__mpap%22%3A%5B%5D%2C%22%24user_id%22%3A%2200a70e22-fed7-4713-b4c5-9b16ba9c856f%22%7D',
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:145.0) Gecko/20100101 Firefox/145.0",
    "Origin": "https://grok.ylsagi.com",
    "Referer": "https://grok.ylsagi.com/",
}

# ================================
# è³‡æ–™æ¨¡å‹ï¼ˆæ–°å¢å°è©± ID æ¬„ä½ï¼‰
# ================================

class ChatRequest(BaseModel):
    """
    èŠå¤©è«‹æ±‚æ¨¡å‹
    
    æ¬„ä½èªªæ˜ï¼š
    - message: ä½¿ç”¨è€…çš„å•é¡Œï¼ˆå¿…å¡«ï¼‰
    - model: ä½¿ç”¨çš„æ¨¡å‹ï¼ˆå¯é¸ï¼Œé è¨­ grok-3ï¼‰
    - conversation_id: å°è©± IDï¼ˆå¯é¸ï¼Œç”¨æ–¼å¤šè¼ªå°è©±ï¼‰
    - parent_response_id: ä¸Šä¸€æ¬¡çš„å›æ‡‰ IDï¼ˆå¯é¸ï¼Œç”¨æ–¼å¤šè¼ªå°è©±ï¼‰
    
    ä½¿ç”¨ç¯„ä¾‹ï¼š
    
    # ç¬¬ä¸€æ¬¡å°è©±ï¼ˆæ–°å»ºå°è©±ï¼‰
    {
        "message": "ä½ å¥½"
    }
    
    # ç¬¬äºŒæ¬¡å°è©±ï¼ˆç¹¼çºŒå°è©±ï¼‰
    {
        "message": "æˆ‘å‰›æ‰èªªäº†ä»€éº¼ï¼Ÿ",
        "conversation_id": "ä¸Šæ¬¡å›å‚³çš„ conversation_id",
        "parent_response_id": "ä¸Šæ¬¡å›å‚³çš„ response_id"
    }
    """
    message: str
    model: Optional[str] = "grok-3"
    conversation_id: Optional[str] = None  # â­ æ–°å¢ï¼šå°è©± ID
    parent_response_id: Optional[str] = None  # â­ æ–°å¢ï¼šçˆ¶å›æ‡‰ ID

class ChatResponse(BaseModel):
    success: bool
    data: Optional[Dict[str, Any]] = None
    error: Optional[str] = None

# ================================
# å»ºæ§‹è«‹æ±‚è² è¼‰ï¼ˆæ”¯æ´å…©ç¨®æ¨¡å¼ï¼‰
# ================================

def build_payload_new(message: str, model: str = "grok-3") -> dict:
    """
    å»ºæ§‹ã€Œæ–°å°è©±ã€çš„è«‹æ±‚è² è¼‰
    ç”¨æ–¼ç¬¬ä¸€æ¬¡å°è©±
    """
    return {
        "disableMemory": False,
        "disableSearch": False,
        "disableSelfHarmShortCircuit": False,
        "disableTextFollowUps": False,
        "enableImageGeneration": True,
        "enableImageStreaming": True,
        "enableSideBySide": True,
        "fileAttachments": [],
        "forceConcise": False,
        "forceSideBySide": False,
        "imageAttachments": [],
        "imageGenerationCount": 2,
        "isAsyncChat": False,
        "isReasoning": False,
        "message": message,
        "modelMode": "MODEL_MODE_AUTO",
        "modelName": model,
        "responseMetadata": {},
        "modelConfigOverride": {},
        "modelMap": {},
        "requestModelDetails": {
            "modelId": model
        },
        "returnImageBytes": False,
        "returnRawGrokInXaiRequest": False,
        "sendFinalMetadata": True,
        "temporary": False,
        "toolOverrides": {}
    }

def build_payload_continue(message: str, parent_response_id: str, model: str = "grok-3") -> dict:
    """
    å»ºæ§‹ã€Œç¹¼çºŒå°è©±ã€çš„è«‹æ±‚è² è¼‰
    ç”¨æ–¼ç¬¬äºŒæ¬¡åŠä¹‹å¾Œçš„å°è©±
    
    åƒæ•¸ï¼š
        message: ä½¿ç”¨è€…çš„æ–°å•é¡Œ
        parent_response_id: ä¸Šä¸€æ¬¡çš„å›æ‡‰ IDï¼ˆé‡è¦ï¼ç”¨ä¾†ä¸²é€£å°è©±ï¼‰
        model: æ¨¡å‹åç¨±
    """
    return {
        "customPersonality": "",
        "disableArtifact": False,
        "disableMemory": False,  # ä¸åœç”¨è¨˜æ†¶
        "disableSearch": False,
        "disableSelfHarmShortCircuit": False,
        "disableTextFollowUps": False,
        "enableImageGeneration": True,
        "enableImageStreaming": True,
        "enableSideBySide": True,
        "fileAttachments": [],
        "forceConcise": False,
        "forceSideBySide": False,
        "imageAttachments": [],
        "imageGenerationCount": 2,
        "isAsyncChat": False,
        "isFromGrokFiles": False,
        "isReasoning": False,
        "isRegenRequest": False,
        "message": message,
        "metadata": {},
        "modelConfigOverride": {},
        "modelMap": {},
        "request_metadata": {
            "mode": "auto",
            "model": model
        },
        "mode": "auto",
        "model": model,
        "requestModelDetails": {
            "modelId": model,
            "modelMode": "MODEL_MODE_AUTO",
            "modelName": model
        },
        "parentResponseId": parent_response_id,  # â­ é—œéµï¼šä¸²é€£å°è©±çš„ ID
        "returnImageBytes": False,
        "returnRawGrokInXaiRequest": False,
        "sendFinalMetadata": True,
        "skipCancelCurrentInflightRequests": False,
        "toolOverrides": {}
    }

# ================================
# è§£æä¸²æµå¼å›æ‡‰ï¼ˆä¿æŒä¸è®Šï¼‰
# ================================

def parse_streaming_response(response) -> Dict[str, Any]:
    """è§£æ Grok çš„ä¸²æµå¼å›æ‡‰"""
    full_response = ""
    response_id = None
    conversation_id = None
    line_count = 0
    
    logger.info("é–‹å§‹è§£æä¸²æµå¼å›æ‡‰...")
    
    try:
        for line in response.iter_lines():
            if line:
                line_count += 1
                try:
                    line_str = line.decode('utf-8')
                    
                    if line_count <= 5:
                        logger.info(f"Line {line_count}: {line_str[:200]}")
                    
                    data = json.loads(line_str)
                    
                    if "result" in data:
                        result = data["result"]
                        
                        if "response" in result:
                            inner_response = result["response"]
                            
                            if "token" in inner_response:
                                token = inner_response["token"]
                                if token:
                                    full_response += token
                            
                            if "responseId" in inner_response:
                                response_id = inner_response["responseId"]
                            
                            if "modelResponse" in inner_response:
                                model_resp = inner_response["modelResponse"]
                                if "message" in model_resp:
                                    full_response = model_resp["message"]
                                    logger.info(f"Got full message: {full_response[:100]}")
                                if "responseId" in model_resp:
                                    response_id = model_resp["responseId"]
                            
                            if inner_response.get("isSoftStop", False):
                                logger.info("Received soft stop")
                                break
                        
                        if "conversation" in result:
                            conv = result["conversation"]
                            if "conversationId" in conv:
                                conversation_id = conv["conversationId"]
                                logger.info(f"Got conversationId: {conversation_id}")
                        
                        if "token" in result:
                            token = result["token"]
                            if token:
                                full_response += token
                        
                        if "conversationId" in result:
                            conversation_id = result["conversationId"]
                        
                        if "responseId" in result:
                            response_id = result["responseId"]
                
                except json.JSONDecodeError as e:
                    logger.warning(f"JSON decode error: {e}")
                    continue
                except Exception as e:
                    logger.error(f"Error parsing line: {e}")
                    continue
        
        logger.info(f"Parsing completed. Lines: {line_count}, Response length: {len(full_response)}")
        
    except Exception as e:
        logger.error(f"Error during iteration: {e}")
    
    return {
        "response": full_response,
        "response_id": response_id,
        "conversation_id": conversation_id,
        "debug_line_count": line_count
    }

# ================================
# API è·¯ç”±ç«¯é»
# ================================

@app.get("/")
async def root():
    return {
        "name": "Grok Mirror API - å¤šè¼ªå°è©±ç‰ˆ",
        "version": "4.0.0",
        "status": "running",
        "features": [
            "æ”¯æ´å–®æ¬¡å°è©±ï¼ˆä¸å‚³ conversation_idï¼‰",
            "æ”¯æ´å¤šè¼ªå°è©±ï¼ˆå‚³å…¥ conversation_id å’Œ parent_response_idï¼‰"
        ]
    }

@app.get("/health")
async def health():
    return {"status": "healthy"}

@app.post("/api/chat", response_model=ChatResponse)
async def chat(request: ChatRequest):
    """
    æ™ºæ…§èŠå¤©ç«¯é» - è‡ªå‹•åˆ¤æ–·æ–°å°è©±æˆ–ç¹¼çºŒå°è©±
    
    åˆ¤æ–·é‚è¼¯ï¼š
    1. å¦‚æœæœ‰ conversation_id å’Œ parent_response_id â†’ ç¹¼çºŒå°è©±
    2. å¦‚æœæ²’æœ‰ â†’ å»ºç«‹æ–°å°è©±
    
    å›å‚³å…§å®¹ï¼š
    - response: Grok çš„å›è¦†
    - conversation_id: å°è©± IDï¼ˆè«‹ä¿å­˜ï¼ä¸‹æ¬¡è¦ç”¨ï¼‰
    - response_id: å›æ‡‰ IDï¼ˆè«‹ä¿å­˜ï¼ä¸‹æ¬¡è¦ç”¨ï¼‰
    - is_new_conversation: æ˜¯å¦ç‚ºæ–°å°è©±ï¼ˆç”¨æ–¼é™¤éŒ¯ï¼‰
    """
    try:
        if not request.message:
            return ChatResponse(success=False, error="Message is required")
        
        logger.info(f"æ”¶åˆ°è«‹æ±‚: {request.message}")
        logger.info(f"å°è©± ID: {request.conversation_id}")
        logger.info(f"çˆ¶å›æ‡‰ ID: {request.parent_response_id}")
        
        # ===== é—œéµé‚è¼¯ï¼šåˆ¤æ–·æ˜¯æ–°å°è©±é‚„æ˜¯ç¹¼çºŒå°è©± =====
        
        is_new_conversation = False
        
        if request.conversation_id and request.parent_response_id:
            # æƒ…æ³ 1ï¼šç¹¼çºŒç¾æœ‰å°è©±
            logger.info("æ¨¡å¼ï¼šç¹¼çºŒå°è©±")
            url = f"{GROK_BASE_URL}/rest/app-chat/conversations/{request.conversation_id}/responses"
            payload = build_payload_continue(request.message, request.parent_response_id, request.model)
            conversation_id = request.conversation_id  # ä½¿ç”¨å‚³å…¥çš„å°è©± ID
        else:
            # æƒ…æ³ 2ï¼šå»ºç«‹æ–°å°è©±
            logger.info("æ¨¡å¼ï¼šæ–°å°è©±")
            url = f"{GROK_BASE_URL}/rest/app-chat/conversations/new"
            payload = build_payload_new(request.message, request.model)
            conversation_id = None  # ç­‰å¾…å¾å›æ‡‰ä¸­å–å¾—
            is_new_conversation = True
        
        # æº–å‚™è«‹æ±‚æ¨™é ­
        headers = HEADERS.copy()
        headers["x-xai-request-id"] = str(uuid.uuid4())
        headers["x-statsig-id"] = "JdqGp+hE6q0WsMpDDLRldv0O6ZNb+Mny24KLm/R/9pJdezRyT5a+PbxEdMFEOTVSTrW47iG05JO2DhUM3iJUk/pqbz4SJg"
        
        logger.info(f"ç™¼é€è«‹æ±‚åˆ°: {url}")
        
        # ç™¼é€è«‹æ±‚
        response = requests.post(
            url,
            headers=headers,
            json=payload,
            stream=True,
            timeout=60
        )
        
        logger.info(f"æ”¶åˆ°å›æ‡‰ï¼Œç‹€æ…‹ç¢¼: {response.status_code}")
        
        if response.status_code == 200:
            result = parse_streaming_response(response)
            
            # å¦‚æœæ˜¯æ–°å°è©±ï¼Œå¾å›æ‡‰ä¸­å–å¾— conversation_id
            if is_new_conversation and result.get("conversation_id"):
                conversation_id = result.get("conversation_id")
            
            logger.info(f"è§£æçµæœ: response_length={len(result.get('response', ''))}")
            
            if not result.get("response"):
                return ChatResponse(
                    success=False,
                    error="No response text extracted",
                    data={
                        "debug_info": {
                            "lines_processed": result.get("debug_line_count", 0),
                            "response_id": result.get("response_id"),
                            "conversation_id": conversation_id
                        }
                    }
                )
            
            # æˆåŠŸå›å‚³
            return ChatResponse(
                success=True,
                data={
                    "response": result.get("response", ""),
                    "conversation_id": conversation_id,  # â­ é‡è¦ï¼šå›å‚³çµ¦å®¢æˆ¶ç«¯ä¿å­˜
                    "response_id": result.get("response_id"),  # â­ é‡è¦ï¼šå›å‚³çµ¦å®¢æˆ¶ç«¯ä¿å­˜
                    "is_new_conversation": is_new_conversation,  # æ˜¯å¦ç‚ºæ–°å°è©±
                    "message_received": request.message  # é™¤éŒ¯ç”¨ï¼šç¢ºèªæ”¶åˆ°çš„è¨Šæ¯
                }
            )
        else:
            error_text = response.text[:200]
            logger.error(f"HTTPéŒ¯èª¤ {response.status_code}: {error_text}")
            return ChatResponse(
                success=False,
                error=f"Request failed with status {response.status_code}",
                data={"details": error_text}
            )
            
    except requests.Timeout:
        logger.error("è«‹æ±‚é€¾æ™‚")
        return ChatResponse(success=False, error="Request timeout")
    except Exception as e:
        logger.error(f"æœªçŸ¥éŒ¯èª¤: {str(e)}", exc_info=True)
        return ChatResponse(success=False, error=f"Error: {str(e)}")

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=7860)
```

---

## ğŸ¯ **åœ¨ Dify ä¸­é…ç½®å¤šè¼ªå°è©±**

### **æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ Chatflowï¼ˆæ¨è–¦ï¼‰**

#### **æ­¥é©Ÿ 1ï¼šæ–°å¢å°è©±è®Šæ•¸**

åœ¨ Dify Chatflow ä¸­ï¼š
1. é»æ“Šå·¦å´ã€Œè®Šæ•¸ã€æˆ–ã€ŒVariablesã€
2. æ–°å¢å…©å€‹è®Šæ•¸ï¼š

```yaml
è®Šæ•¸ 1:
  åç¨±: grok_conversation_id
  é¡å‹: String
  é è¨­å€¼: (ç•™ç©º)
  æè¿°: Grok å°è©± ID

è®Šæ•¸ 2:
  åç¨±: grok_response_id
  é¡å‹: String
  é è¨­å€¼: (ç•™ç©º)
  æè¿°: Grok å›æ‡‰ ID
```

#### **æ­¥é©Ÿ 2ï¼šå·¥ä½œæµé…ç½®**

```
Start 
  â†’ HTTP Request (å‘¼å« Grok API)
  â†’ Code (æ›´æ–°å°è©±è®Šæ•¸)
  â†’ Answer (é¡¯ç¤ºå›è¦†)
```

#### **æ­¥é©Ÿ 3ï¼šHTTP Request ç¯€é»**

**ç¯€é»åç¨±ï¼š** `grok_api`

**URLï¼š** `https://2hf2hf-deploy.hf.space/api/chat`

**Methodï¼š** `POST`

**Headersï¼š**
```
Content-Type: application/json
```

**Bodyï¼ˆJSONï¼‰ï¼š**
```json
{
  "message": "{{#sys.query#}}",
  "conversation_id": "{{#grok_conversation_id#}}",
  "parent_response_id": "{{#grok_response_id#}}"
}
```

#### **æ­¥é©Ÿ 4ï¼šCode ç¯€é»ï¼ˆæ›´æ–°è®Šæ•¸ï¼‰**

**ç¯€é»åç¨±ï¼š** `update_context`

**è¼¸å…¥è®Šæ•¸ï¼š**
```
api_response (string) = {{#grok_api.body#}}
```

**ç¨‹å¼ç¢¼ï¼š**
```python
import json

def main(api_response: str) -> dict:
    """
    æ›´æ–°å°è©±ä¸Šä¸‹æ–‡
    å¾ API å›æ‡‰ä¸­æå– conversation_id å’Œ response_id
    """
    try:
        # è§£æ API å›æ‡‰
        data = json.loads(api_response) if isinstance(api_response, str) else api_response
        
        if data.get("success"):
            result_data = data.get("data", {})
            
            # æ›´æ–°å°è©±è®Šæ•¸ï¼ˆDify æœƒè‡ªå‹•ä¿å­˜é€™äº›å€¼ï¼‰
            return {
                "answer": result_data.get("response", ""),
                "new_conversation_id": result_data.get("conversation_id", ""),
                "new_response_id": result_data.get("response_id", ""),
                "is_new": result_data.get("is_new_conversation", False)
            }
        else:
            return {
                "answer": f"éŒ¯èª¤ï¼š{data.get('error', 'æœªçŸ¥éŒ¯èª¤')}",
                "new_conversation_id": "",
                "new_response_id": "",
                "is_new": False
            }
    except Exception as e:
        return {
            "answer": f"è§£æéŒ¯èª¤ï¼š{str(e)}",
            "new_conversation_id": "",
            "new_response_id": "",
            "is_new": False
        }
```

**è¼¸å‡ºè®Šæ•¸ï¼š**
- `answer` (string)
- `new_conversation_id` (string)
- `new_response_id` (string)
- `is_new` (boolean)

**è®Šæ•¸è³¦å€¼ï¼ˆåœ¨ Code ç¯€é»å¾Œï¼‰ï¼š**
```
grok_conversation_id = {{#update_context.new_conversation_id#}}
grok_response_id = {{#update_context.new_response_id#}}
```

#### **æ­¥é©Ÿ 5ï¼šAnswer ç¯€é»**

```jinja2
{{#update_context.answer#}}
```

æˆ–å¸¶é™¤éŒ¯è³‡è¨Šï¼š
```jinja2
{{#update_context.answer#}}

{% if update_context.is_new %}
ğŸ’¬ æ–°å°è©±å·²å»ºç«‹
{% else %}
ğŸ’¬ ç¹¼çºŒå°è©±ä¸­
{% endif %}
```

---

### **æ–¹æ¡ˆ 2ï¼šç°¡åŒ–ç‰ˆï¼ˆç„¡ Code ç¯€é»ï¼‰**

å¦‚æœä¸æƒ³ç”¨ Code ç¯€é»ï¼Œå¯ä»¥ç”¨é€™å€‹ç°¡åŒ–æ–¹æ¡ˆï¼š

**HTTP Request Bodyï¼š**
```json
{
  "message": "{{#sys.query#}}",
  "conversation_id": "{{#grok_conversation_id#}}",
  "parent_response_id": "{{#grok_response_id#}}"
}
```

**è®Šæ•¸è³¦å€¼ï¼ˆç›´æ¥åœ¨ HTTP Request å¾Œï¼‰ï¼š**
```
grok_conversation_id = {{#(grok_api.body | fromjson).data.conversation_id#}}
grok_response_id = {{#(grok_api.body | fromjson).data.response_id#}}
```

**Answerï¼š**
```jinja2
{{#(grok_api.body | fromjson).data.response#}}
```

---

## ğŸ§ª **æ¸¬è©¦å¤šè¼ªå°è©±**

### **æ¸¬è©¦å°è©±ç¯„ä¾‹ï¼š**

```
ğŸ‘¤ ä½¿ç”¨è€…ï¼šæˆ‘å–œæ­¡åƒè˜‹æœ
ğŸ¤– Grokï¼šå¤ªå¥½äº†ï¼è˜‹æœæ˜¯å¾ˆå¥åº·çš„æ°´æœ...
     [ç³»çµ±å„²å­˜ï¼šconversation_id=abc123, response_id=xyz456]

ğŸ‘¤ ä½¿ç”¨è€…ï¼šæˆ‘å‰›æ‰èªªæˆ‘å–œæ­¡åƒä»€éº¼ï¼Ÿ
ğŸ¤– Grokï¼šä½ å‰›æ‰èªªä½ å–œæ­¡åƒè˜‹æœã€‚
     [ç³»çµ±ä½¿ç”¨ï¼šconversation_id=abc123, parent_response_id=xyz456]
     [ç³»çµ±æ›´æ–°ï¼šresponse_id=def789]

ğŸ‘¤ ä½¿ç”¨è€…ï¼šå®ƒæœ‰ä»€éº¼ç‡Ÿé¤Šï¼Ÿ
ğŸ¤– Grokï¼šè˜‹æœå¯Œå«ç¶­ç”Ÿç´  Cã€çº–ç¶­...
     [ç³»çµ±ä½¿ç”¨ï¼šconversation_id=abc123, parent_response_id=def789]
```

---

## ğŸ“Š **å·¥ä½œæµç¨‹åœ–**

```
ç¬¬ä¸€è¼ªå°è©±ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½¿ç”¨è€…ï¼šä½ å¥½ â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚ conversation_id = ""
      â”‚ parent_response_id = ""
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Grok API    â”‚
â”‚ (æ–°å°è©±æ¨¡å¼) â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ å›å‚³ï¼š
      â”‚ - response: "ä½ å¥½ï¼"
      â”‚ - conversation_id: "abc123"
      â”‚ - response_id: "xyz456"
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å„²å­˜è®Šæ•¸     â”‚
â”‚ conv_id = abc123
â”‚ resp_id = xyz456
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬äºŒè¼ªå°è©±ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½¿ç”¨è€…ï¼šä½ å«ä»€éº¼åå­—ï¼Ÿâ”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ conversation_id = "abc123"
      â”‚ parent_response_id = "xyz456"
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Grok API    â”‚
â”‚ (ç¹¼çºŒå°è©±æ¨¡å¼)â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ å›å‚³ï¼š
      â”‚ - response: "æˆ‘æ˜¯ Grok"
      â”‚ - conversation_id: "abc123"
      â”‚ - response_id: "def789"
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ›´æ–°è®Šæ•¸     â”‚
â”‚ conv_id = abc123
â”‚ resp_id = def789  â† æ›´æ–°ï¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… **æ›´æ–°æª¢æŸ¥æ¸…å–®**

### **API ç«¯ï¼ˆHugging Faceï¼‰ï¼š**
- [ ] æ›´æ–° main.py ç‚ºå¤šè¼ªå°è©±ç‰ˆæœ¬
- [ ] ä¿å­˜ä¸¦ç­‰å¾…é‡æ–°éƒ¨ç½²
- [ ] æ¸¬è©¦ /docs ç¢ºèª API æ­£å¸¸

### **Dify ç«¯ï¼š**
- [ ] æ–°å¢å…©å€‹å°è©±è®Šæ•¸
- [ ] ä¿®æ”¹ HTTP Request Body åŒ…å« conversation_id å’Œ parent_response_id
- [ ] æ–°å¢ Code ç¯€é»æ›´æ–°è®Šæ•¸
- [ ] è¨­å®šè®Šæ•¸è³¦å€¼
- [ ] æ¸¬è©¦å¤šè¼ªå°è©±

### **æ¸¬è©¦ï¼š**
- [ ] ç¬¬ä¸€æ¬¡å•å•é¡Œï¼ˆæ‡‰è©²å»ºç«‹æ–°å°è©±ï¼‰
- [ ] ç¬¬äºŒæ¬¡å•ã€Œæˆ‘å‰›æ‰èªªäº†ä»€éº¼ã€ï¼ˆæ‡‰è©²è¨˜å¾—ï¼‰
- [ ] ç¹¼çºŒå¤šè¼ªå°è©±ç¢ºèªè¨˜æ†¶åŠŸèƒ½

---

æ›´æ–°å¾Œæ¸¬è©¦çœ‹çœ‹ï¼Œæœ‰ä»»ä½•å•é¡Œéš¨æ™‚å‘Šè¨´æˆ‘ï¼ğŸš€
